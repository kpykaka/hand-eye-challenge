<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çœ¼æ‰‹å”èª¿æŒ‘æˆ°è³½</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .slide-in { animation: slideIn 0.5s ease-out; }
    .pulse { animation: pulse 1s infinite; }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .progress-bar { transition: width 0.1s linear; }
  </style>
</head>
<body class="bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center min-h-screen">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h1 class="text-3xl font-bold text-center mb-4 text-purple-700">æ‰‹çœ¼å”èª¿æŒ‘æˆ°è³½</h1>
    
    <!-- åƒè³½è€…è¼¸å…¥ -->
    <div class="mb-4">
      <label for="participantName" class="block text-sm font-medium text-gray-700">ç©å®¶åç¨±</label>
      <input id="participantName" type="text" class="mt-1 p-2 w-full border rounded-md focus:ring-2 focus:ring-purple-500" placeholder="è¼¸å…¥ä½ çš„éŠæˆ²ID" required>
    </div>
    
    <!-- è¨ˆæ™‚æ§åˆ¶ -->
    <div class="flex justify-between mb-4">
      <button id="startButton" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 pulse">é–‹å§‹æŒ‘æˆ°</button>
      <button id="stopButton" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600" disabled>çµæŸæŒ‘æˆ°</button>
    </div>
    
    <!-- è¨ˆæ™‚é¡¯ç¤ºèˆ‡é€²åº¦æ¢ -->
    <div class="text-center mb-4">
      <span id="timerDisplay" class="text-2xl font-mono text-purple-700">00:00.00</span>
      <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
        <div id="progressBar" class="bg-purple-500 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
      </div>
    </div>
    
    <!-- å³æ™‚æ’åæç¤º -->
    <div id="rankMessage" class="text-center text-lg font-semibold mb-4 hidden"></div>
    
    <!-- æ’è¡Œæ¦œ -->
    <h2 class="text-lg font-semibold mb-2 text-purple-700">è‹±é›„æ¦œ</h2>
    <div class="max-h-96 overflow-y-auto">
      <ul id="leaderboard" class="divide-y divide-gray-200"></ul>
    </div>
  </div>

  <!-- Firebase SDK (æ¨¡çµ„åŒ–å¯«æ³•) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // âœ… Firebase è¨­å®šï¼ˆç”¨ä½ æä¾›çš„ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyBMRnpFPi7By0Efxuvp3CW9LVrMPJac5oE",
      authDomain: "eyehandchallenge.firebaseapp.com",
      databaseURL: "https://eyehandchallenge-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "eyehandchallenge",
      storageBucket: "eyehandchallenge.firebasestorage.app",
      messagingSenderId: "6116040467",
      appId: "1:6116040467:web:db79d7a5b643d9e7afc4e6",
      measurementId: "G-RLMHVTLCRG"
    };

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let startTime, timerInterval;
    const maxTime = 60; // é€²åº¦æ¢æœ€å¤§æ™‚é–“ (60ç§’)

    // DOM å…ƒç´ 
    const startButton = document.getElementById("startButton");
    const stopButton = document.getElementById("stopButton");
    const participantInput = document.getElementById("participantName");
    const timerDisplay = document.getElementById("timerDisplay");
    const progressBar = document.getElementById("progressBar");
    const rankMessage = document.getElementById("rankMessage");
    const leaderboard = document.getElementById("leaderboard");

    // é–‹å§‹è¨ˆæ™‚
    startButton.addEventListener("click", () => {
      const name = participantInput.value.trim();
      if (!name) {
        alert("è«‹è¼¸å…¥ä½ çš„éŠæˆ²IDï¼");
        return;
      }
      startTime = new Date();
      startButton.disabled = true;
      stopButton.disabled = false;
      participantInput.disabled = true;
      rankMessage.classList.add("hidden");
      timerInterval = setInterval(updateTimer, 10);
      playSound("start.mp3");
    });

    // çµæŸæŒ‘æˆ°
    stopButton.addEventListener("click", () => {
      clearInterval(timerInterval);
      const endTime = new Date();
      const timeTaken = (endTime - startTime) / 1000;
      const name = participantInput.value.trim();

      // âœ… å°‡æˆç¸¾å¯«å…¥ Firebase
      set(ref(db, "results/" + name), timeTaken);

      // é‡ç½® UI
      startButton.disabled = false;
      stopButton.disabled = true;
      participantInput.disabled = false;
      participantInput.value = "";
      timerDisplay.textContent = "00:00.00";
      progressBar.style.width = "0%";

      playSound("end.mp3");
    });

    // æ›´æ–°è¨ˆæ™‚å™¨
    function updateTimer() {
      const now = new Date();
      const timeElapsed = (now - startTime) / 1000;
      const minutes = Math.floor(timeElapsed / 60);
      const seconds = Math.floor(timeElapsed % 60);
      const milliseconds = Math.floor((timeElapsed % 1) * 100);
      timerDisplay.textContent = 
        `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
      const progress = Math.min((timeElapsed / maxTime) * 100, 100);
      progressBar.style.width = `${progress}%`;
    }

    // âœ… Firebase æ’è¡Œæ¦œå³æ™‚åŒæ­¥
    const resultsRef = ref(db, "results");
    onValue(resultsRef, (snapshot) => {
      leaderboard.innerHTML = "";
      if (snapshot.exists()) {
        let results = snapshot.val();
        let sorted = Object.entries(results).sort((a, b) => a[1] - b[1]);
        sorted.forEach(([name, time], index) => {
          const li = document.createElement("li");
          li.className = `py-2 flex justify-between slide-in ${index < 10 ? 'bg-yellow-100' : ''}`;
          const medal = index === 0 ? "ğŸ¥‡" : index === 1 ? "ğŸ¥ˆ" : index === 2 ? "ğŸ¥‰" : index < 10 ? "ğŸ…" : "";
          li.innerHTML = `<span>${index + 1}. ${name} ${medal}</span><span>${time.toFixed(2)} ç§’</span>`;
          leaderboard.appendChild(li);
        });

        // é¡¯ç¤ºè‡ªå·±æ’å
        const playerName = participantInput.value.trim();
        if (playerName) {
          const myRank = sorted.findIndex(r => r[0] === playerName) + 1;
          if (myRank > 0) {
            rankMessage.textContent = myRank <= 10 ?
              `ğŸ‰ æ­å–œï¼ä½ æ’åç¬¬ ${myRank}` :
              `ä½ çš„æ’åï¼šç¬¬ ${myRank}`;
            rankMessage.classList.remove("hidden");
          }
        }
      }
    });

    // æ’­æ”¾éŸ³æ•ˆ
    function playSound(file) {
      const audio = new Audio(file);
      audio.play().catch(() => console.log("éŸ³æ•ˆæ’­æ”¾å¤±æ•—"));
    }
  </script>
</body>
</html>
